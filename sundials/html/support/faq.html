<html>

<head>

<title>SUNDIALS FAQ</title>

<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../graphics/download_button.png";
supporton = new Image();        supporton.src = "../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../graphics/support_button.png";
//-->
</script>
<script src="../sunjs.js" type="text/javascript" language="javascript1.2"></script>

</head>

<!-- ******************************************************************************** -->

<body>


<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">

  <tr valign="top">
  <td height="60" background="../graphics/table_bck1.gif"><img src="../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../graphics/head_support_top_right.png" height="60" width="720" border="0"></td>
  <td background="../graphics/table_bck1.gif"><img src="../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>

  <tr valign="top">
  <td height="127" background="../graphics/table_bck2.gif"><img src="../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../graphics/table_bck2.gif"><img src="../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>

  <tr valign="top">
  <td background="../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../graphics/table_bck5.gif">
    <a href="../sitemap.html"><img SRC="../graphics/sitemap.png" border="0"></a><img SRC="../graphics/logo.png" border="0">
  </td>

  <td width="720" bgcolor="#ffffff">
  <div id="content">   

<!-- Start content for this page -->

<div class="title">Frequently Asked Questions</div>
<br><br>

<!-- ------ -->

<h1>Contents</h1>
<div class="frame">
<ul>
<li><a href="#inst">Installation</a>
  <ul>
  <li><a href="#inst_path">I got the tarball. What do I do next?</a></li>
  <li><a href="#inst_linux">What configure flags do I really need?</a></li>
  <li><a href="#inst_c++">Can I use a C++ compiler to build SUNDIALS?</a></li>
  <li><a href="#inst_noconfig">How do I build SUNDIALS without using the configure script?</a></li>
  <li><a href="#inst_win">How do I install SUNDIALS under Windows?</a></li>
  <li><a href="#inst_cygwin">How can I generate shared libraries under cygwin?</a></li>
  <li><a href="#inst_32vs64bit">Should I build 32-bit or 64-bit SUNDIALS libraries?</a></li>
  <li><a href="#inst_linking">Everything installed fine! How do I link the SUNDIALS libraries to my own application?</a></li>
  </ul>
<li><a href="#cvode">CVODE / CVODES</a>
  <ul>
  <li><a href="#cvode_tols">How do I choose tolerances?</a></li>
  <li><a href="#cvode_linsolv">How do I choose what linear solver to use for the stiff case?</a></li>
  <li><a href="#cvode_data">How do I handle a data-defined function within the RHS function?</a></li>
  <li><a href="#cvode_negvals">How do I control unphysical negative values?</a></li>
  <li><a href="#cvode_disc">How do I treat discontinuities in the RHS function?</a></li>
  <li><a href="#cvode_ewtfn">When is it advantegeous to supply my own EwtFn function?</a></li>
  <li><a href="#cvodes_senstoggle">How do I switch on/off forward sensitivity computations in CVODES?</a></li>
  <li><a href="#cvodes_plist">What is the role of plist in CVODES?</a></li>
  <li><a href="#cvodes_pbar">What is the role of pbar in CVODES?</a></li>
  <li><a href="#cvodes_quad">What is pure quadrature integration?</a></li>
  </ul>
<li><a href="#ida">IDA</a>
  <ul>
  <li><a href="#ida_tols">How do I choose tolerances in IDA?</a></li>
  <li><a href="#ida_linsolv">How do I choose what linear solver to use?</a></li>
  <li><a href="#ida_data">How do I handle a data-defined function within the residual function?</a></li>
  <li><a href="#ida_negvals">How do I control unphysical negative values in IDA?</a></li>
  <li><a href="#ida_disc">How do I treat discontinuities in the residual function in IDA?</a></li>
  <li><a href="#ida_ewtfn">When is it advantegeous to supply my own EwtFn function?</a></li>
  </ul>
<li><a href="#kinsol">KINSOL</a>
  <ul>
  <li><a href="#kinsol_reinit">How do I reinitialize KINSOL within a C/C++ program?</a></li>
  <li><a href="#kinsol_violateconstr">Why is the system function being evaluated at points that violate the constraints?</a></li>
  </ul>
<!--
<li><a href="#stb">sundialsTB</a>
  <ul>
  <li></li>
  <li></li>
  <li></li>
  </ul>
-->
<li><a href="#miscellaneous">Miscellaneous</a>
  <ul>
  <li><a href="#find_version">How do I determine which version of SUNDIALS I have?</a></li>
  <li><a href="#inst_patch">How do I apply a patch under UNIX or Linux?</a></li>
  </ul>
</ul>

</div>

<!-- ================ INSTALLATION ===========================  -->

<a name="inst"></a>
<h1>Installation</h1>
<div class="frame">

<a name="inst_path"></a>
<div class="faq_q">I got the tarball. What do I do next?</div>
<div class="faq_a">
Let's assume you downloaded <tt>sundials-x.y.z.tar.gz</tt>.
First, you'll have to uncompress and unpack it:
<pre>
% <b>tar -xzf sundials-x.y.z.tar</b>
</pre>
This will create a directory <tt>sundials-x.y.z</tt>, which we will call <em>srcdir</em>.
(Note that if you only downloaded an individual solver tarball, call it <tt>solver-x.y.z.tar.gz</tt>,
uncompressing and unpacking it will result in the directory <tt>solver-x.y.z</tt>.) 
<br><br>
Next, you need to configure and build the SUNDIALS libraries. You can get some information 
on how to do this here, but more details are available in the user guides 
(e.g. <tt>sundials/cvode/doc/cv_guide.pdf</tt>).
<br><br>
If your system does not support <tt>configure</tt> scripts, see 
<a href="#inst_noconfig">How do I build SUNDIALS without using the configure script?</a>
<br><br>
Otherwise, the first thing to decide now is where you'd like to install the SUNDIALS libraries and header files. 
We will call this directory <em>instdir</em>.
You will specify this through the <tt>--prefix</tt> option to <tt>configure</tt> (if <tt>--prefix</tt> is not specified, 
<em>instdir</em> defaults to <tt>usr/local</tt>.). 
<font color="#ff0000">WARNING</font>: In no circumstances, should you use the same <em>instdir</em> as
the source directory <em>srcdir</em>, as this would result in errors when attempting to 
install the exported header files. 
<br><br>
Next, from within <em>srcdir</em>, you configure, build, and install SUNDIALS:
<pre>
% <b>cd</b> srcdir
% <b>./configure</b> --prefix=instdir &lt;configure-options&gt;
% <b>make</b>
% <b>make install</b>
</pre>
If everything went fine, the SUNDIALS libraries were installed in <em>instdir</em><tt>/lib</tt>,
the exported header files were installed in various subdirectories of <em>instdir</em><tt>/include</tt>,
and the <tt>sundials-config</tt> executable script was installed in <em>instdir</em><tt>/bin</tt>.
If compilation of the SUNDIALS examples was enabled through the <tt>--enable-examples</tt> option
to <tt>configure</tt> then these were installed in various subdirectores of <em>exinstdir</em>, where
<em>exinstsdir</em> was specified through the <tt>--with-examples-instdir</tt> option 
(default <em>instdir</em><tt>/examples</tt>). Similarly, if compilation of the Matlab toolbox <tt>sundialsTB</tt>
was enabled at configuration time (<tt>--enable-sundialsTB</tt>), then it was installed in 
<em>stbinstdir</em><tt>/sundialsTB</tt>, where <em>stbinstdir</em> was specified with
<tt>--with-sundialsTB-instdir</tt> (default <tt>$MATLAB/toolbox</tt>).
</div>

<a name="inst_linux"></a>
<div class="faq_q">What configure flags do I really need?</div>
<div class="faq_a">
That depends a lot on how your system is configured. If all compilers, libraries, and system 
header files are in the usual places, configuring SUNDIALS can be as simple as:
<pre>
% <b>./configure</b>
% <b>make</b>
% <b>make install</b>
</pre>
In certain circumstances, more sophisticated configure lines may be needed, especially
when building SUNDIALS with MPI support and/or the Fortran-C interfaces. For example, 
to build SUNDIALS using <tt>gcc</tt> as the serial C compiler, <tt>g77</tt> as the 
serial Fortran compiler, using the MPI compiler scripts <tt>mpicc</tt> and
<tt>mpif77</tt> from a particular MPICH distribution, and using the additional 
compiler flag <tt>-g3</tt>, you would use:
<pre>
% <b>configure CC=gcc F77=g77 --with-cflags=-g3 --with-fflags=-g3 \</b>
<b>      --with-mpicc=/usr/apps/mpich/1.2.4/bin/mpicc \</b>
<b>      --with-mpif77=/usr/apps/mpich/1.2.4/bin/mpif77</b>
</pre>

</div>

<a name="inst_c++"></a>
<div class="faq_q">Can I use a C++ compiler to build SUNDIALS?</div>
<div class="faq_a">
Yes. However, if building SUNDIALS using a C++ compiler and with parallel support, 
you must take care <b>not</b> to include MPI C++ bindings. This can be done by 
specifying an implementation-dependent MPI flag using --with-mpi-flags:
<br>
&nbsp;&nbsp;&nbsp;&diams; for MPICH, use --with-mpi-flags=-DMPICH_SKIP_MPICXX
<br>
&nbsp;&nbsp;&nbsp;&diams; for LAM MPI, use --with-mpi-flags=-DLAM_BUILDING
<br><br>
On the other hand, in order to resolve all necessary symbols while linking
the parallel Fortran libraries, you must either use the MPI wrapper using
the C++ compiler (i.e. specify --with-mpif77=mpiCC), or else add the stdc++
library (i.e. specify --with-libs=-lstdc++).
<br><br>
Note that, if you want to use an MPI script, you must specify, through --with-mpicc, 
the wrapper using the C++ compiler (mpiCC or mpic++, depending on your MPI distribution). 
If a C++ compiler is specified and --with-mpicc is not specified, the SUNDIALS configure 
script will automaticall select the correct MPI script. 
</div>


<a name="inst_noconfig"></a>
<div class="faq_q">How do I install SUNDIALS without using the configure script?</div>
<div class="faq_a">
Complete details on bulding SUNDIALS without using the default build system are provided
in the "Building SUNDIALS without the configure script" section of the installation
chapter in any of the SUNDIALS user guides. This type of installation  requires manually
creating the <tt><b>sundials_config.h</b></tt> header file
[ <a href="samples/sundials_config.h.html" onclick="window.open('samples/sundials_config.h.html', 'popup', 'width=600,height=800,scrollbars=yes,menubar=yes');return false">view</a> | <a href="samples/sundials_config.h">download</a> ]
</div>

<a name="inst_win"></a>
<div class="faq_q">How do I install SUNDIALS under Windows?</div>
<div class="faq_a">
The easiest way of obtaining Windows libraries for the SUNDIALS solvers is probably
to use <tt>cygwin</tt> (<a href="http://www.cygwin.com" target="_blank">www.cygwin.com</a>),
in which case the installation procedure is the same as for any other *NIX system.
<br><br>

Several of our users have reported successfuly building the SUNDIALS libraries using
various IDEs (Borland C++, Visual C++, etc.). For more details,
browse also the <a href="mailArchive/maillist.html" target="_blank">sundials-users</a> 
mailing list.
<!--
<ul><li>
  <ul>
  <li><a href="samples/instructions_vc8.html" onclick="window.open('samples/instructions_vc8.html', 'popup', 'width=600,height=800,scrollbars=yes,menubar=yes');return false">
      Instructions to compile SUNDIALS with VC8 - Visual Studio C++ Express 2005</a> -- courtesy of Andreas Nicolai</li>
  <li><a href="samples/project_vc71.html" onclick="window.open('samples/project_vc71.html', 'popup', 'width=600,height=800,scrollbars=yes,menubar=yes');return false">
      Project files to build CVODE v2.4.0 using Microsoft Visual C++ .NET (VC7.1)</a> -- courtesy of Sze-Ping Wong</li>
  </ul>
</ul>
-->


</div>

<a name="inst_cygwin"></a>
<div class="faq_q">How can I generate shared libraries under cygwin?</div>
<div class="faq_a">
In order to create shared libraries (DLLs) under <tt>cygwin</tt>, you must <b>regenerate</b> the
<tt>configure</tt> script using <tt>cygwin</tt>'s autotools and use the <tt>-no-undefined</tt>
option to <tt>libtool</tt>.
<ol>
<li>
Remove, if they exist, the <tt>aclocal.m4</tt> file and <tt>autom4te.cache</tt>
directory:
<pre>
% <b>rm -rf aclocal.m4 autom4te.cache</b>
</pre>
</li>
<li>
Regenerate the <tt>configure</tt> script:
<pre>
% <b>aclocal</b>
% <b>autoconf</b>
% <b>autoheader</b>
</pre>
</li>
<li>
Configure SUNDIALS, enabling creation of shared libraries and using the required
flag:
<pre>
% <b>./configure --enable-shared --with-ldflags=-no-undefined</b>
</pre>
</li>
</ol>
</div>

<a name="inst_32vs64bit"></a>
<div class="faq_q">Should I build 32-bit or 64-bit SUNDIALS libraries?</div>
<div class="faq_a">
Typically, the "bitness" of a CPU refers to the size of the linear address space a process
can address (e.g., an IA-32 processor can address up to 4GB).  Consequently, if your program
does not require more than 4GB of memory, then there is probably no benefit to building a
64-bit library.
<br>
<br>
People are also often confused by the nomenclature, but the "bitness" of a CPU has nothing
to do with the accuracy of floating-point computations or the size of floating-point numeric
data types.  Regardless of the "bitness" of the processor, real numbers are stored in the
IEEE Standard 754 floating-point format.  Therefore, building a 64-bit library will not
increase the accuracy of your numerical results.
</div>

<a name="inst_linking"></a>
<div class="faq_q">Everything installed fine! How do I link the SUNDIALS libraries to my own application?</div>
The easiest way to determine the preprocessor and linker flags required to link the SUNDIALS libraries to 
a user application is to invoke, from within the Makefile, the executable script <tt>sundials-config</tt>
available in <em>instdir</em><tt>/bin</tt>. Its usage is as follows:
<pre><tt>
Usage: sundials-config -m cvode|cvodes|ida|kinsol -t s|p -l c|f [-s libs|cppflags -hv]
Requires: standard GNU commands
Options:
    -m cvode|cvodes|ida|kinsol   SUNDIALS module
    -t s|p                       use serial or parallel vectors
    -l c|f                       use C or Fortran
    -s libs|cppflags             show linking flags or C preprocessor flags.
                                 (show both if option not given.)
    -h                           usage and options (this help)
    -v                           view this script
Notes:
    '-l f' is not valid for '-m cvodes'
    '-s cppflags' returns an empty string for '-l f'
</tt></pre>

With this, a sample Makefile to compile a CVODE application witten in C and using the serial NVECTOR module
could look as follows:
<pre><tt>
SHELL = /bin/sh
 
CC       = gcc
CFLAGS   = -g -O
CPPFLAGS =
LDFLAGS  =
 
SUN_DISTRO = /home/radu/CODES/sundials-2.3.0-mpich1_gcc
 
MY_APPS = app1 app2

all:
        @sun_cppflags=`eval "${SUN_DISTRO}/bin/sundials-config -m cvode -t s -l c -s cppflags"`; \
         sun_ldflags=`eval "${SUN_DISTRO}/bin/sundials-config -m cvode -t s -l c -s libs"`;      \
         for i in ${MY_APPS} ; do                                                                \
           echo "--- Making $${i} ---" ;                                                         \
           eval "make SUN_CPPFLAGS='$${sun_cppflags}' SUN_LDFLAGS='$${sun_ldflags}' $${i}";      \
         done

app1: app1.c
        ${CC} ${CPPFLAGS} ${SUN_CPPFLAGS} ${CFLAGS} -c app1.c
        ${CC} -o app1 app1.o ${CFLAGS} ${LDFLAGS} ${SUN_LDFLAGS}
app2: app2.c
        ${CC} ${CPPFLAGS} ${SUN_CPPFLAGS} ${CFLAGS} -DMY_PREPROC_DIR -c app2.c
        ${CC} -o app2 app2.o ${CFLAGS} ${LDFLAGS} ${SUN_LDFLAGS}

clean:
        rm -f *.o
        rm -f ${MY_APPS}
</tt></pre>
</div>

</div>

<!-- ================= CVODE ===================== -->

<a name="cvode"></a>
<h1>CVODE / CVODES</h1>
<div class="frame">

<a name="cvode_tols"></a>
<div class="faq_q">How do I choose tolerances?</div>
<div class="faq_a">
For many users, the appropriate choices for tolerance values are a
concern.  The following pieces of advice are relevant.
<ol>
<li> The scalar relative tolerance reltol is to be set to control relative
errors.  So reltol = 1.0E-4 means that errors are controlled to .01%.  We
do not recommend using reltol larger than 1.0E-3.  On the other hand,
reltol should not be so small that it is comparable to the unit roundoff
of the machine arithmetic (generally around 1.0E-15).</li>
<li> The absolute tolerances abstol (whether scalar or vector) need to
be set to control absolute errors when any components of the solution
vector y may be so small that pure relative error control is
meaningless.  For example, if y[i] starts at some nonzero value, but in time
decays to zero, then pure relative error control on y[i] makes no sense
(and is overly costly) after y[i] is below some noise level.  Then
abstol (if scalar) or abstol[i] (if a vector) needs to be set to that
noise level.  If the different components have different noise levels,
then abstol should be a vector.  See the example cvdenx in the CVODE
package, and the discussion of it in the CVODE Examples document.
In that problem, the three components vary betwen 0 and 1, and have
different noise levels; hence the abstol vector.  It is impossible to
give any general advice on abstol values, because the appropriate noise
levels are completely problem-dependent.  The user or modeler hopefully has
some idea as to what those noise levels are.</li>
<li> Finally, it is important to pick all the tolerance values conservatively,
because they control the error committed on each individual time step.
The final (global) errors are some sort of accumulation of those
per-step errors.  A good rule of thumb is to reduce the tolerances by a
factor of .01 from the actual desired limits on errors.  So if you
want .01% accuracy (globally), a good choice is reltol = 1.0E-6.
But in any case, it is a good idea to do a few experiments with
the tolerances to see how the computed solution values vary as
tolerances are reduced.</li>
</ol>
</div>

<a name="cvode_linsolv"></a>
<div class="faq_q">How do I choose what linear solver to use for the stiff case?</div>
<div class="faq_a">
(a) If the problem is size is fairly small (say N < 100), then using
the dense solver is probably best; it is the simplest to use, and
reasonably inexpensive for small N.  For larger N, it is important to
take advantage of sparsity (zero-nonzero) structure within the problem.
<br>
(b) If there is local (nearest-neighbor) coupling, or if the coupling
is local after a suitable reordering of y, then use the banded linear
solver.  Local coupling means that the i-th component of the RHS or
residual function depends only on components y_j for which |i-j| is
small relative to N.  (Note that the dense and band solvers are only
applicable for the serial version of the solver.)
<br>
(c) For even larger problems, consider one of the Krylov iterative
methods.  These are hardest to use, because for best results they
usually require preconditioning.  However they offer the best
opportunity to exploit the sparsity structure in the problem.  The
preconditioner is a matrix which, at least crudely, approximates the
actual matrix in the linear system to be solved, and is typically
built from an approximation of the relevant Jacobian matrix.
Typically, that approximation uses only part of the true Jacobian, but
as a result is much less expensive to solve.  If the Jacobian can be
approximated by a matrix that is banded (serial case) or
block-diagonal with banded blocks (parallel case), SUNDIALS includes
preconditioner modules for such cases.  In each of the user guides,
the section 'Linear solver specification functions' and the section on
preconditioner modules contain more detailed comments on preconditioning.
<br>
(d) On the construction of preconditioners for problems arising from
the spatial discretization of time-dependent partial differential
equation systems, there is considerable discussion in the paper
   P. N. Brown and A. C. Hindmarsh, "Reduced Storage Matrix Methods
   in Stiff ODE Systems," J. Appl. Math. & Comp., 31 (1989), pp.40-91.
</div>

<a name="cvode_data"></a>
<div class="faq_q">How do I handle a data-defined function within the RHS function?</div>
<div class="faq_a">
Often the RHS or residual function depends on some function
A(t) that is data-defined, i.e. defined only at a set of discrete set
of times t.  The solver must be able to obtain values of the
user-supplied functions at arbitrary times t in the integration
interval.  So the user must fit the data with a reasonably smooth
function A(t) that is defined continuously for all relevant t, and
incorporate an evaluation of that fit function in the user function
involved.  This may be as simple as a piecewise linear fit, but a
smoother fit (e.g. spline) would make the integration more efficient.
If there is noise in the data, the fit should be a least-squares fit
instead of a straight interpolation.  The same advice applies if the
user function has a data-defined function A(y) that involves one or
more components of the dependent variable vector y.  Of course, if
more that one component is involved, the fit is more complicated.
</div>

<a name="cvode_negvals"></a>
<div class="faq_q">How do I control unphysical negative values?</div>
<div class="faq_a">
In many applications, some components in the true solution are always
positive or non-negative, though at times very small.  In the numerical
solution, however, small negative (hence unphysical) values can then
occur.  In most cases, these values are harmless, and simply need to
be controlled, not eliminated. The following pieces of advice are relevant.
<ol>
<li> The way to control the size of unwanted negative computed values
is with tighter absolute tolerances.  Again this requires some
knowledge of the noise level of these components, which may or may not
be different for different components.  Some experimentation may be
needed.</li>
<li> If output plots or tables are being generated, and it is important
to avoid having negative numbers appear there (for the sake of avoiding
a long explanation of them, if nothing else), then eliminate them, but
only in the context of the output medium.  Then the internal values carried
by the solver are unaffected.  Remember that a small negative value in y
returned by CVODE, with magnitude comparable to abstol or less,
is equivalent to zero as far as the computation is concerned.</li>
<li> The user's right-hand side routine f should <b>never</b> change a
negative value in the solution vector y to a non-negative value,
as a "solution" to this problem.  This can cause instability.  If the
f routine cannot tolerate a zero or negative value (e.g. because
there is a square root or log of it), then the offending value should
be changed to zero or a tiny positive number in a temporary variable
(<b>not</b> in the input y vector) for the purposes of computing f(t,y).</li>
</ol>
</div>

<a name="cvode_disc"></a>
<div class="faq_q">How do I treat discontinuities in the RHS function?</div>
<div class="faq_a">
If the jumps at the discontinuities are relatively small, simply
keep them in the RHS function, and let the integrator respond to
them (possibly taking smaller steps through each point of discontinuity).
If the jumps are large, it is more efficient to stop at the point of
discontinuity and restart the integrator with a readjusted ODE model.
To stop when the location of the discontinuity is known, simply make
that location a value of tout.  To stop when the location of the
discontinuity is determined by the solution, use the rootfinding feature.
In either case, it is critical that the RHS function <b>not</b> incorporate
the discontinuity, but rather have a smooth extention over the
discontinuity, so that the step across it (and subsequent rootfinding,
if used) can be done efficiently.  Then use a switch within the
RHS function that can be flipped between the stopping of the
integration and the restart, so that the restarted problem uses the
new values (which have jumped).
</div>

<a name="cvode_ewtfn"></a>
<div class="faq_q">When is it advantegeous to supply my own EwtFn function?</div>
<div class="faq_a">
The main situation where this is a good idea is where the problem
needs something "in between" the cases covered by CV_SS and CV_SV.
Namely, suppose there are a few groups of variables (relative to the
total number of variables) such that all the variables in each group
require the same value of abstol, but these values are very different
from one group to another.  Then a user EwtFn function can keep an
array of those values and construct the ewt vector without any
additional storage.  Also, <i>in rare cases</i>, one may want to use this
option to apply different values of reltol to different variables (or
groups of variables).
</div>

<a name="cvodes_senstoggle"></a>
<div class="faq_q">How do switch on/off forward sensitivity computations in CVODES?</div>
<div class="faq_a">
If you want to turn on and off forward sensitivity calculations during several 
successive integrations (such as if you were using CVODES within a dynamically-constrained 
optimization loop, when sometimes you want to only integrate the states and sometimes you 
also need sensitivities computed), it is most efficient to use <tt>CVodeSensToggleOff</tt>. 
<br><br>
Sensitivity calculations are enabled by the following functions: 
<tt>CVodeSensMalloc</tt> and <tt>CVodeSensReInit</tt>
and are disabled by <tt>CVodeSensFree</tt> (after calling this one, they can 
be re-enabled <b>only</b> by calling <tt>CVodeSensMalloc</tt>) and 
<tt>CVodeSensToggleOff</tt>.
<br><br>
</div>

<a name="cvodes_plist"></a>
<div class="faq_q">What is the role of plist in CVODES?</div>
<div class="faq_a">
The argument <tt>plist</tt> to <tt>CVodeSetSensParams</tt> is used to specify the problem parameters 
with respect to which solution sensitivities are to be computed.
<br><br>
<tt>plist</tt> is used <b>only</b> if the sensitivity right-hand sides are evaluated using the 
internal difference-quotient approximation function. In that case, <tt>plist</tt> should be declared
as an array of <tt>Ns</tt> integers and should contain 
the indeces in the array of problem parameters <tt>p</tt> with respect to which sensitivities 
are desired. For example, if you want to compute sensitivities with respect to the first and 
third parameters in the <tt>p</tt> array, p[0] and p[2], you need to set 
<pre>
plist[0] = 0
plist[1] = 2
</pre>
<br>
If <tt>plist</tt> is not provided, CVODES will compute sensitivities with respect to the first <tt>Ns</tt>
parameters in the array <tt>p</tt> (i.e. it will use <tt>plist[i]=i, i=0,1,...Ns</tt>). 
<br><br>
If the user provides a function to evaluate the righ-hand sides of the sensitivity equations or if 
the default values are desired, a <tt>NULL</tt> pointer can be passed to <tt>CVodeSetSensParams</tt>.
</div>


<a name="cvodes_pbar"></a>
<div class="faq_q">What is the role of pbar in CVODES?</div>
<div class="faq_a">
The argument <tt>pbar</tt> to <tt>CVodeSetSensParams</tt> is used to specify scaling factors for
the problem parameters.
<br><br>
<tt>pbar</tt> is used <b>only if</b><br>
&diams; the internal difference-quotient functions are used for the evaluation of the sensitivity 
right-hand sides, in which case <tt>pbar</tt> is used in computing an appropriate perturbation 
for the finite-difference approximation<br>
<b>or</b><br>
&diams; the tolerances for the sensitivity variables are estimated automatically by CVODES from those
specified for the state variables.
<br><br>
If provided, <tt>pbar</tt> should be declared as an array of <tt>Ns</tt> <tt>realtype</tt>s and should 
contain <b>non-zero</b> scaling factors for the <tt>Ns</tt> parameters with respect to which
sensitivities are to be computed. For non-zero problem parameters, a good choice is
<pre>
pbar[i] = p[plist[i]]
</pre>
<br>
If <tt>pbar</tt> is not provided, CVODES will use <tt>pbar[i]=1.0, i=0,1,...Ns-1</tt>. 
<br><br>
If the user provides a function to evaluate the righ-hand sides of the sensitivity equations and also
specifies tolerances for the sensitivity variables (through <tt>CVodeSetSensTolerances</tt>) or if 
the default values are desired, a <tt>NULL</tt> pointer can be passed to <tt>CVodeSetSensParams</tt>.
</div>

<a name="cvodes_quad"></a>
<div class="faq_q">What is pure quadrature integration?</div>
<div class="faq_a">
Suppose your ODE is y'=F(t,y) and you integrate it from 0 to T and that
you are also interested in computing an integral of the form<br>
G = int_0^T g(t,y(t)) dt<br>
for some function g. The most efficient way of computing z is by
appending one additional differential equation to your ODE system:<br>
z' = g(t,y)<br>
with initial condition z(0)=0, in which case<br>
G = z(T)
<br><br>
This additional equation is "a pure quadrature equation" and its main characteristic is that the new differential 
variable z does not appear in the right hand side of the extended ODE system. If CVODES is notified of such "pure 
quadrature equations", it can take advantage of this property and do less work than if it didn't know about them
(these variables need not be considered in the nonlinear system solution).
<br><br>
The main reason for the special treatment of "pure quadrature equations" in CVODES is that such integrals (very often a
large number of them) need to be computed for adjoint sensitivity.
</div>


</div>

<!-- ================ IDA =================== -->

<a name="ida"></a>
<h1>IDA</h1>
<div class="frame">

<a name="ida_tols"></a>
<div class="faq_q">How do I choose tolerances in IDA?</div>
<div class="faq_a">
See <a href="#cvode_tols">How do I choose tolerances?</a> in the CVODE/CVODES section.
</div>

<a name="ida_linsolv"></a>
<div class="faq_q">How do I choose what linear solver to use?</div>
<div class="faq_a">
See <a href="#cvode_linsolv">How do I choose what linear solver to use for the stiff case?</a> in the CVODE/CVODES section.
</div>

<a name="ida_data"></a>
<div class="faq_q">How do I handle a data-defined function within the residual function?</div>
<div class="faq_a">
See <a href="#cvode_data">How do I handle a data-defined function within the RHS function?</a> in the CVODE/CVODES section.
</div>

<a name="ida_negvals"></a>
<div class="faq_q">How do I control unphysical negative values in IDA?</div>
<div class="faq_a">
See <a href="#cvode_negvals">How do I control unphysical negative values?</a> in the CVODE/CVODES section.
<br>
In addition, IDA provides the option of enforcing positivity or non-negativity
on components.  But these constraint options should only be exercised if
the use of absolute tolerances to control the computed values is
unsuccessful, because they involve some extra overhead cost.
</div>

<a name="ida_disc"></a>
<div class="faq_q">How do I treat discontinuities in the residual function in IDA?</div>
<div class="faq_a">
See <a href="#cvode_disc">How do I treat discontinuities in the RHS function?</a> in the CVODE/CVODES section.
</div>

<a name="ida_ewtfn"></a>
<div class="faq_q">When is it advantegeous to supply my own EwtFn function?</div>
<div class="faq_a">
See <a href="#cvode_ewtfn">How do I treat discontinuities in the RHS function?</a> in the CVODE/CVODES section.
</div>

</div>

<!-- ================ KINSOL ================== -->

<a name="kinsol"></a>
<h1>KINSOL</h1>
<div class="frame">

<a name="kinsol_reinit"></a>
<div class="faq_q">How do I reinitialize KINSOL within a C/C++ program?</div>
<div class="faq_a">
Although KINSOL does not provide a reinitialization function, it is possible to reinitialize the solver (meaning reuse
a KINSOL object), but only if the problem size remains unchanged.  To reinitialize KINSOL, begin by making any necessary
changes to the problem definition by calling the appropriate <tt>KINSet*</tt> functions (e.g., <tt>KINSetSysFunc</tt>).
Next, if you would like to use a different linear solver, call the appropriate function (e.g., <tt>KINDense</tt>) followed
by any calls to the corresponding <tt>KIN*Set*</tt> functions.  Then you can call the <tt>KINSol</tt> function to solve
the updated nonlinear algebraic system.
</div>

<a name="kinsol_violateconstr"></a>
<div class="faq_q">Why is the system function being evaluated at points that violate the constraints?</div>
<div class="faq_a">
If you have not supplied a function to compute either J(u) (of type <tt>KINDenseJacFn</tt> or <tt>KINBandJacFn</tt>)
or J(u)v (of type <tt>KINSpilsJacTimesVecFn</tt>), then the internal function may be the culprit.
The default function used to compute a difference quotient approximation to the Jacobian (direct methods) or
Jacobian matrix-vector product (Kylov methods) evaluates the user-supplied system function at a slightly perturbed
point, but does not check if that point violates the constraints.
</div>

</div>

<!-- =============== sundialsTB ================== -->

<!--

<a name="stb"></a>
<h1>sundialsTB</h1>
<div class="frame">

<a name=""></a>
<div class="faq_q">Q?</div>
<div class="faq_a">
a
</div>

<a name=""></a>
<div class="faq_q">Q?</div>
<div class="faq_a">
a
</div>

</div>

-->

<!-- ================ MISCELLANEOUS ================== -->

<a name="miscellaneous"></a>
<h1>Miscellaneous</h1>
<div class="frame">

<a name="find_version"></a>
<div class="faq_q">How do I determine which version of SUNDIALS I have?</div>
<div class="faq_a">
If you still have access to the distribution files, then the SUNDIALS release number is indicated in the
header of <tt>sundials/README</tt> and the corresponding solver versions can be determined by reading the
appropriate row of the "Release History" table. Otherwise, you will need to find the value associated with
the <tt>PACKAGE_VERSION</tt> or <tt>SUNDIALS_PACKAGE_VERSION</tt> variable defined in the
<tt>sundials_config.h</tt> header file (located under either <tt>&lt;install_dir&gt;/include</tt> or
<tt>&lt;install_dir&gt;/sundials/include</tt>), and then read the appropriate row of
the following table:
<br>
<br>
<center>
<table border cellpadding=1 cellspacing=0>
<!-- <tr align=center> <th rowspan=2>SUNDIALS Release</th> <th colspan=4>Solver Version</th> </tr> -->
<tr align=center>
     <td width=110 rowspan=2><b>SUNDIALS Release</b></td> <td colspan=4><b>Solver Version</b></td>
</tr>
<tr align=center>
     <td width=50><b>CVODE</b></td> <td width=50><b>CVODES</b></td> <td width=50><b>IDA</b></td> <td width=50><b>KINSOL</b></td>
</tr>
<tr align=center>
     <td>1.0</td> <td>2.0</td> <td>1.0</td> <td>2.0</td> <td>2.0</td>
</tr>
<tr align=center>
     <td>2.0</td> <td>2.2.0</td> <td>2.1.0</td> <td>2.2.0</td> <td>2.2.0</td>
</tr>
<tr align=center>
     <td>2.0.1</td> <td>2.2.1</td> <td>2.1.1</td> <td>2.2.1</td> <td>2.2.1</td>
</tr>
<tr align=center>
     <td>2.0.2</td> <td>2.2.2</td> <td>2.1.2</td> <td>2.2.2</td> <td>2.2.2</td>
</tr>
<tr align=center>
     <td>2.1.0</td> <td>2.3.0</td> <td>2.2.0</td> <td>2.3.0</td> <td>2.3.0</td>
</tr>
<tr align=center>
     <td>2.1.1</td> <td>2.3.0</td> <td>2.3.0</td> <td>2.3.0</td> <td>2.3.0</td>
</tr>
<tr align=center>
     <td>2.2.0</td> <td>2.4.0</td> <td>2.4.0</td> <td>2.4.0</td> <td>2.4.0</td>
</tr>
<tr align=center>
     <td>2.3.0</td> <td>2.5.0</td> <td>2.5.0</td> <td>2.5.0</td> <td>2.5.0</td>
</tr>
</table>
</center>
</div>

<a name="inst_patch"></a>
<div class="faq_q">How do I apply a patch under UNIX or Linux?</div>
<div class="faq_a">
To apply patch <tt>foobar.patch</tt> and rebuild SUNDIALS complete the following steps:
<pre>
% <b>cp foobar.patch</b> &lt;sundials_source_dir&gt;
% <b>cd</b> &lt;sundials_source_dir&gt;
% <b>patch -p1 < foobar.patch</b>
% <b>cd</b> &lt;sundials_source_dir&gt;
% <b>make</b>
% <b>make install</b>
</pre>
</div>

</div>

<!-- ------ -->

<!-- End content for this page -->
  </div>
  </td>

  <td background="../graphics/table_bck3.gif"></td>
  </tr>

  <tr valign="top">
  <td height="17" background="../graphics/table_bck4.gif"><img src="../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../graphics/table_bck4.gif"><img src="../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>

  </table>

</body>
</html>
